generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Image model - can belong to users, shops, or products
model images {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  fileId    String
  url       String
  userId    String?   @db.ObjectId
  shopId    String?   @db.ObjectId
  productId String?   @db.ObjectId
  users     users?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  shops     shops?    @relation(fields: [shopId], references: [id], onDelete: Cascade)
  products  products? @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([shopId])
  @@index([productId])
}

// User model
model users {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  email          String           @unique
  password       String?
  avatar         images[]
  following      String[]         @db.ObjectId
  followedShops  shops[]          @relation("ShopFollowers", fields: [following], references: [id])
  shopReviews    shopReviews[]
  productReviews productReviews[]
  orders         orders[]
  addresses      addresses[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  userAnalytics  userAnalytics?
}

// User Address model
model addresses {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  label     String
  name      String
  phone     String
  address   String
  city      String
  zpi       String
  country   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Shop reviews
model shopReviews {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  rating    Float
  reviews   String?
  shopId    String   @db.ObjectId
  shop      shops    @relation(fields: [shopId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([shopId])
  @@index([rating])
}

// Product reviews
model productReviews {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  rating    Float
  review    String?
  productId String   @db.ObjectId
  product   products @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([rating])
}

// Product ratings aggregation
model productRatings {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  productId     String   @unique @db.ObjectId
  product       products @relation(fields: [productId], references: [id], onDelete: Cascade)
  averageRating Float    @default(0.0)
  totalReviews  Int      @default(0)
  fiveStars     Int      @default(0)
  fourStars     Int      @default(0)
  threeStars    Int      @default(0)
  twoStars      Int      @default(0)
  oneStar       Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([averageRating])
  @@index([totalReviews])
}

// Shop model
model shops {
  id               String             @id @default(auto()) @map("_id") @db.ObjectId
  name             String             @unique
  description      String
  category         String
  avatar           images[]
  coverBanner      String?
  address          String
  openingHours     String?
  website          String?
  socialLinks      Json[]
  ratings          Float              @default(0.0)
  reviews          shopReviews[]
  sellerId         String             @unique @db.ObjectId
  seller           sellers            @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  products         products[]
  orders           orders[]
  productAnalytics productAnalytics[]
  followerIds      String[]           @db.ObjectId
  followers        users[]            @relation("ShopFollowers", fields: [followerIds], references: [id])
  followersCount   Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([category])
  @@index([ratings])
  @@index([createdAt])
}

// Seller model
model sellers {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  email         String          @unique
  phone         String
  country       String
  password      String?
  stripeId      String?         @unique
  shop          shops?
  discountCodes discountCodes[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// Site configuration
model siteConfigs {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  categories    String[]
  subCategories Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Discount codes
model discountCodes {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  type       String // e.g., "percentage", "fixed"
  value      Float
  code       String    @unique
  sellerId   String    @db.ObjectId
  seller     sellers   @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  minAmount  Float?    @default(0) // Minimum order amount to apply discount
  maxAmount  Float? // Maximum discount amount
  usageLimit Int?      @default(0) // 0 means unlimited
  usedCount  Int       @default(0)
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([sellerId])
  @@index([isActive])
  @@index([expiresAt])
  @@index([sellerId, isActive])
}

// Product status enum
enum productStatus {
  ACTIVE
  PENDING
  DRAFT
  OUT_OF_STOCK
}

// Product model
model products {
  id                   String            @id @default(auto()) @map("_id") @db.ObjectId
  status               productStatus     @default(ACTIVE)
  title                String
  slug                 String            @unique
  category             String
  subCategory          String
  description          String
  detailDescription    String
  stock                Int
  salePrice            Float
  regularPrice         Float
  ratings              Float             @default(0.0)
  images               images[]
  reviews              productReviews[]
  orderItems           orderItems[]
  productRating        productRatings?
  productAnalytics     productAnalytics?
  discountCodes        String[]          @db.ObjectId
  tags                 String[]
  colors               String[]
  sizes                String[]
  cod                  Boolean           @default(false)
  brand                String?
  warranty             String?
  videoUrl             String?
  customSpecifications Json?
  customProperties     Json?
  isDeleted            Boolean           @default(false)
  viewCount            Int               @default(0)
  soldCount            Int               @default(0)
  startingDate         DateTime?
  endingDate           DateTime?
  createdAt            DateTime          @default(now())
  deletedAt            DateTime?
  deletePermanentlyAt  DateTime?
  updatedAt            DateTime          @updatedAt
  shopId               String            @db.ObjectId
  shop                 shops             @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([category])
  @@index([subCategory])
  @@index([status])
  @@index([ratings])
  @@index([salePrice])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([isDeleted])
  @@index([stock])
  @@index([viewCount])
  @@index([soldCount])
  @@index([shopId, isDeleted])
  @@index([shopId, stock])
  @@index([shopId, isDeleted, stock])
  @@index([title])
  @@index([deletePermanentlyAt])
}

// User Analytics model
model userAnalytics {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @unique @db.ObjectId
  user        users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  actions     Json[]
  country     String?
  city        String?
  device      String?
  lastVisited DateTime?
  lastLogin   DateTime?
  loginCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([lastLogin])
  @@index([loginCount])
}

// Product Analytics model
model productAnalytics {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  productId            String    @unique @db.ObjectId
  product              products  @relation(fields: [productId], references: [id], onDelete: Cascade)
  shopId               String?   @db.ObjectId
  shop                 shops?    @relation(fields: [shopId], references: [id], onDelete: Cascade)
  views                Int       @default(0)
  purchases            Int       @default(0)
  addedToCarts         Int       @default(0)
  addedToWishlists     Int       @default(0)
  removedFromCarts     Int       @default(0)
  removedFromWishlists Int       @default(0)
  lastVisitedAt        DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([shopId])
  @@index([views])
  @@index([purchases])
  @@index([lastVisitedAt])
}

// Order status enum
enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

// Payment status enum
enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// Order model
model orders {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  userId          String        @db.ObjectId
  user            users         @relation(fields: [userId], references: [id])
  shopId          String        @db.ObjectId
  shop            shops         @relation(fields: [shopId], references: [id])
  totalAmount     Float
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String
  shippingAddress Json
  items           orderItems[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([shopId])
  @@index([status])
  @@index([createdAt])
}

// Order Item model
model orderItems {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String   @db.ObjectId
  order     orders   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String   @db.ObjectId
  product   products @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
  color     String?
  size      String?
}
